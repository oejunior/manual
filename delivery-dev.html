<!DOCTYPE html>
<!--
DOCDE • DELIVERY DEV — STEP 3
Features incluídas:
✔ Editar entregador
✔ Excluir (desativar) entregador
✔ Corrigir entregador da entrega
✔ Totais do dia (pedidos + taxas)
✔ Mostrar usuário logado
✔ Logout manual
-->
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Docce • Delivery (DEV)</title>
<link href="https://fonts.googleapis.com/css2?family=Signika:wght@400;600&display=swap" rel="stylesheet">
<style>
body{margin:0;font-family:Signika,system-ui;background:#0f0f10;color:#f3f3f4}
header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid #2a2a2f}
button{background:#1e1e22;color:#f3f3f4;border:1px solid #2a2a2f;border-radius:12px;padding:8px 14px;cursor:pointer}
button.danger{color:#ff5c5c}
button.good{color:#2ecc71}
main{padding:18px}
.hidden{display:none}
.card{border:1px solid #2a2a2f;border-radius:16px;padding:14px;margin-bottom:14px}
.row{display:flex;gap:10px;flex-wrap:wrap}
input{background:#1e1e22;border:1px solid #2a2a2f;color:#fff;border-radius:10px;padding:8px}
.list{margin-top:10px}
.item{border-bottom:1px dashed #333;padding:8px 0}
.small{font-size:12px;color:#aaa}
</style>
</head>
<body>

<header>
  <div>
    <strong>Docce • Delivery (DEV)</strong><br>
    <span class="small" id="userInfo">não logado</span>
  </div>
  <div>
    <button id="btnCouriers">Entregadores</button>
    <button id="btnLogout">Sair</button>
  </div>
</header>

<main>

<section class="card">
<h3>Nova entrega</h3>
<div class="row">
<input id="dClient" placeholder="Cliente">
<input id="dTotal" placeholder="Total">
<input id="dFee" placeholder="Taxa">
<input id="dCourier" placeholder="Código entregador (opcional)">
<button class="good" id="addDelivery">Adicionar</button>
</div>
</section>

<section class="card">
<h3>Entregas do dia</h3>
<div id="deliveryList" class="list"></div>
</section>

<section class="card">
<h3>Resumo do dia</h3>
<div id="summary"></div>
</section>

</main>

<!-- MODAL ENTREGADORES -->
<div id="courierModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center">
<div style="background:#151518;padding:20px;border-radius:16px;width:420px">
<h3>Entregadores</h3>
<div class="row">
<input id="cName" placeholder="Nome">
<input id="cPhone" placeholder="Telefone">
<input id="cPix" placeholder="PIX">
<button class="good" id="saveCourier">Salvar</button>
</div>
<div id="courierList" class="list"></div>
<button id="closeCourier">Fechar</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "COLE_AQUI",
  authDomain: "COLE_AQUI",
  projectId: "COLE_AQUI",
  storageBucket: "COLE_AQUI",
  messagingSenderId: "COLE_AQUI",
  appId: "COLE_AQUI"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const $ = id => document.getElementById(id);
const locale = navigator.language || "pt-BR";
const money = v => new Intl.NumberFormat(locale,{style:"currency",currency:"BRL"}).format(v||0);
const parseMoney = v => Number(String(v).replace(".","").replace(",","."))||0;

onAuthStateChanged(auth, user=>{
  if(user){
    $("userInfo").textContent = "logado como " + user.email;
    loadAll();
  }else{
    $("userInfo").textContent = "não logado";
  }
});

$("btnLogout").onclick = ()=>signOut(auth);

async function loadAll(){
  loadDeliveries();
  loadCouriers();
}

async function loadDeliveries(){
  const snap = await getDocs(collection(db,"deliveries"));
  let totalFee=0,totalOrders=0;
  $("deliveryList").innerHTML="";
  snap.forEach(d=>{
    const it=d.data();
    totalFee+=it.fee||0;
    totalOrders+=it.total||0;
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML = `
      <strong>${it.client}</strong>
      <div class="small">Taxa ${money(it.fee)} | Total ${money(it.total)}</div>
      <button data-id="${d.id}" class="edit">Editar entregador</button>
    `;
    div.querySelector(".edit").onclick=()=>{
      const code=prompt("Novo código:");
      if(code) updateDoc(doc(db,"deliveries",d.id),{courierCode:code,updatedAt:serverTimestamp()}).then(loadDeliveries);
    }
    $("deliveryList").appendChild(div);
  });
  $("summary").innerHTML = `
    <div>Total taxas: <strong>${money(totalFee)}</strong></div>
    <div>Total pedidos: <strong>${money(totalOrders)}</strong></div>
  `;
}

$("addDelivery").onclick = async ()=>{
  await addDoc(collection(db,"deliveries"),{
    client:$("dClient").value,
    total:parseMoney($("dTotal").value),
    fee:parseMoney($("dFee").value),
    courierCode:$("dCourier").value||"",
    createdAt:serverTimestamp()
  });
  loadDeliveries();
};

$("btnCouriers").onclick=()=>{$("courierModal").classList.remove("hidden")};
$("closeCourier").onclick=()=>{$("courierModal").classList.add("hidden")};

async function loadCouriers(){
  const snap = await getDocs(collection(db,"couriers"));
  $("courierList").innerHTML="";
  snap.forEach(d=>{
    const c=d.data();
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML = `
      <strong>${c.name}</strong>
      <div class="small">${c.pix}</div>
      <button class="danger">Excluir</button>
    `;
    div.querySelector(".danger").onclick=()=>{
      if(confirm("Excluir entregador?")){
        deleteDoc(doc(db,"couriers",d.id)).then(loadCouriers);
      }
    }
    $("courierList").appendChild(div);
  });
}

$("saveCourier").onclick=async()=>{
  const phone=$("cPhone").value.replace(/\D/g,"");
  const code=phone.slice(-4);
  await updateDoc(doc(db,"couriers",code),{
    name:$("cName").value,
    phone,
    pix:$("cPix").value,
    updatedAt:serverTimestamp()
  },{merge:true});
  loadCouriers();
};
</script>
</body>
</html>
