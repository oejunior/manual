<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Docce ‚Ä¢ Entregas</title>
  <link href="https://fonts.googleapis.com/css2?family=Signika:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f0f10;--stroke:#2a2a2f;--text:#f3f3f4;--muted:#b7b7be;--good:#2ecc71;--warn:#f1c40f;--bad:#ff5c5c;--accent:#e9d7b5;--shadow:0 12px 32px rgba(0,0,0,.45);--radius:16px}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;font-family:"Signika",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:22px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 18px;border:1px solid var(--stroke);background:rgba(23,23,25,.8);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(8px);position:sticky;top:12px;z-index:10}
    .brand{display:flex;align-items:center;gap:10px}.logo{width:36px;height:36px;border-radius:12px;border:1px solid rgba(233,215,181,.35);background:linear-gradient(145deg, rgba(233,215,181,.18), rgba(233,215,181,.04));display:grid;place-items:center;color:var(--accent);font-weight:600}
    .title{line-height:1.1}.title b{display:block;font-size:16px}.title span{display:block;font-size:12px;color:var(--muted)}
    .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{border:1px solid var(--stroke);background:rgba(29,29,32,.85);color:var(--text);padding:10px 12px;border-radius:999px;display:flex;align-items:center;gap:10px;min-height:40px}
    .pill label{font-size:12px;color:var(--muted)}.pill input{border:none;outline:none;background:transparent;color:var(--text);font:inherit;min-width:160px}.pill input[type="date"]{min-width:145px}
    .btn{border:1px solid var(--stroke);background:rgba(233,215,181,.10);color:var(--accent);padding:10px 14px;border-radius:999px;cursor:pointer;font:inherit;transition:.12s transform ease,.12s opacity ease,.12s background ease;user-select:none;white-space:nowrap}
    .btn:hover{transform:translateY(-1px);background:rgba(233,215,181,.14)}.btn:active{transform:translateY(0);opacity:.85}
    .btn.secondary{background:rgba(29,29,32,.85);color:var(--text)}.btn.danger{background:rgba(255,92,92,.10);color:var(--bad);border-color:rgba(255,92,92,.25)}.btn.good{background:rgba(46,204,113,.10);color:var(--good);border-color:rgba(46,204,113,.25)}.btn.tiny{padding:7px 10px;font-size:12px}
    .grid{margin-top:18px;display:grid;grid-template-columns:1.15fr .85fr;gap:14px}@media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{border:1px solid var(--stroke);background:rgba(23,23,25,.82);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .card header{padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px;border-bottom:1px solid var(--stroke);background:linear-gradient(180deg, rgba(233,215,181,.07), transparent)}
    .card header h2{margin:0;font-size:14px}.card header .hint{font-size:12px;color:var(--muted)}.card .body{padding:14px 16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}.row3{grid-template-columns:1fr 1fr 1fr}
    @media(max-width:700px){.row,.row3{grid-template-columns:1fr}.pill input{min-width:0}}
    .field{border:1px solid var(--stroke);background:rgba(29,29,32,.75);border-radius:14px;padding:10px 12px}
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
    .field input{width:100%;border:none;outline:none;background:transparent;color:var(--text);font:inherit;font-size:14px}
    .list{margin-top:10px;border-top:1px dashed rgba(255,255,255,.08);padding-top:10px;display:flex;flex-direction:column;gap:8px}
    .item{border:1px solid rgba(255,255,255,.08);background:rgba(29,29,32,.55);border-radius:14px;padding:10px 12px;display:grid;grid-template-columns:1.2fr .8fr auto;gap:10px;align-items:center}
    .item .main b{display:block;font-size:13px}.item .main small{display:block;color:var(--muted);font-size:12px}
    .item .meta{justify-self:end;text-align:right}.item .meta b{display:block;font-size:13px}.item .meta small{display:block;color:var(--muted);font-size:12px}
    .item .actions{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
    @media(max-width:760px){.item{grid-template-columns:1fr}.item .meta{justify-self:start;text-align:left}.item .actions{justify-content:flex-start}}
    .notice{margin-top:12px;padding:10px 12px;border-radius:14px;border:1px solid rgba(233,215,181,.18);background:rgba(233,215,181,.06);color:var(--accent);font-size:13px}
    .muted{color:var(--muted)}.sep{height:1px;background:rgba(255,255,255,.06);margin:12px 0}.hidden{display:none !important}
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.62);display:none;align-items:center;justify-content:center;padding:18px;z-index:100}
    .backdrop.show{display:flex}
    .modal{width:min(520px,100%);border:1px solid var(--stroke);background:rgba(23,23,25,.96);border-radius:18px;box-shadow:var(--shadow);overflow:hidden}
    .modal header{padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px;border-bottom:1px solid var(--stroke);background:linear-gradient(180deg, rgba(233,215,181,.08), transparent)}
    .modal header b{font-size:14px}.modal .content{padding:14px 16px}.modal .foot{padding:14px 16px;display:flex;gap:10px;justify-content:flex-end;border-top:1px solid var(--stroke)}
    .x{background:transparent;border:none;color:var(--muted);font-size:18px;cursor:pointer}.x:hover{color:var(--text)}
    .tag{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);border:1px solid rgba(255,255,255,.10);padding:6px 10px;border-radius:999px;background:rgba(29,29,32,.55)}
  
    .userline{display:block;margin-top:4px;font-size:12px;color:var(--muted)}
    .pixKey{color:var(--accent);font-weight:600}
    .closeBoxIdle{opacity:.65}
    .totalsHeader{text-align:center;margin:0 0 10px 0}
    .totalsRow{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.02)}

  
    .topbar{flex-direction:column;align-items:stretch;gap:12px}
    .brandline{display:flex;align-items:center;justify-content:flex-start;gap:10px}
    .menu{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .menuleft,.menuright{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .btn.sm{padding:7px 10px;border-radius:12px;font-size:13px}
    .pill input{min-width:140px}
    /* Side panel (right card) */
    .sideHeader{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .sideTitle{flex:1;text-align:center;font-weight:600}
    .sideBody{display:none}
    .sideBody.active{display:block}
    .sideScroll{max-height:46vh;overflow:auto;padding-right:6px}
    .xBtn{background:transparent;border:1px solid var(--line);color:var(--muted);border-radius:12px;width:34px;height:34px;cursor:pointer}

  
    .brandwrap{display:flex;align-items:flex-start;justify-content:space-between;gap:14px}
    .userbox{display:flex;align-items:center;gap:10px;min-width:180px;justify-content:flex-end}
    .avatar{width:38px;height:38px;border-radius:14px;display:flex;align-items:center;justify-content:center;
            border:1px solid var(--line);background:rgba(255,255,255,.03);font-weight:600;color:var(--text)}
    .usertext{display:flex;flex-direction:column;line-height:1.15;text-align:right}
    .usertext .label{font-size:12px;color:var(--muted)}
    .usertext .email{font-size:12px;color:var(--muted)}
    .userbox.hidden{display:none}

  </style>
</head>
<body>
<div class="wrap">
  
<div class="wrap">
  <div class="topbar">
    <div class="brandline"><div class="brandwrap"><div class="brand">
        <div class="logo">D</div>
        <div class="title">
          <b>Docce ‚Ä¢ Entregas</b>
          <span>Controle di√°rio com fechamento autom√°tico</span>
</div>
      </div>
    </div>

    <div class="menu">
      <div class="menuleft">
        <button class="btn secondary sm" id="btnRefresh">Atualizar</button>
        <button class="btn sm" id="btnFechamento">Fechamento</button>
        <button class="btn secondary sm hidden" id="btnShowCouriers">Entregadores</button>
        <button class="btn secondary sm hidden" id="btnShowCadastro">Cadastro</button>
      </div>
      <div class="menuright">
        <div class="pill"><label for="day">Dia</label><input id="day" type="date"></div>
        <button class="btn sm" id="btnOpenLogin">Login</button>
        <button class="btn secondary sm hidden" id="btnLogout">Sair</button>
      </div>
    </div>
  </div>

  <div class="grid">
<div class="grid">
    <section class="card">
      <header>
        <div><h2>Entregas do dia</h2></div>
</header>
      <div class="body">
        <div class="row3">
          <div class="field"><label>Cliente</label><input id="inpCliente" placeholder="Nome do cliente"></div>
          <div class="field"><label>Total (R$)</label><input id="inpTotal" inputmode="decimal" placeholder="0,00"></div>
          <div class="field"><label>Taxa (R$)</label><input id="inpTaxa" inputmode="decimal" placeholder="0,00"></div>
        </div>
        <div class="row">
          <div class="field"><label>C√≥digo do entregador (opcional)</label><input id="inpCodigoEntrega" placeholder="Ex.: 2603" maxlength="4"></div>
          <div style="display:flex;gap:10px;align-items:flex-end">
            <button class="btn good" id="btnAddEntrega">Adicionar</button>
            <button class="btn secondary" id="btnLimpar">Limpar</button>
          </div>
        </div>

        <div class="notice" id="msg"></div>

        <div class="sep"></div>
        <header style="padding:0;border:none;background:none;display:flex;align-items:center;justify-content:space-between">
          <h2 style="margin:0;font-size:14px">Aguardando entregador</h2><span class="hint">Digite o c√≥digo e atribua</span>
        </header>
        <div class="list" id="listPending"></div>

        <div class="sep"></div>
        <header style="padding:0;border:none;background:none;display:flex;align-items:center;justify-content:space-between">
          <h2 style="margin:0;font-size:14px">Entregas atribu√≠das</h2><span class="hint">Editar (trocar entregador) ou excluir</span>
        </header>
        <div class="list" id="listAssigned"></div>
      </div>
    </section>

    
<aside class="card" id="sidePanel">
  <header class="sideHeader">
    <div class="sideTitle" id="sideTitle"> </div>
    <button class="xBtn" id="sideClose" title="Fechar" aria-label="Fechar">√ó</button>
  </header>
  <div class="body">
    <div id="sideFechamento" class="sideBody">
      <div class="item" style="grid-template-columns:1fr auto;">
        <div class="main"><b>Totais de entrega</b></div>
        <div class="meta"><b id="totalTaxaDia">R$ 0,00</b><small class="muted" id="totalEntregasDia">0 entregas</small></div>
      </div>
      <div class="list sideScroll" id="listResumo"></div>
    </div>

    <div id="sideCouriers" class="sideBody">
      <div class="list sideScroll" id="listCouriers"></div>
    </div>

    <div id="sideCadastro" class="sideBody">
      <div class="row">
        <div class="field"><label>Nome</label><input id="cNome" placeholder="Nome do entregador"></div>
        <div class="field"><label>Telefone</label><input id="cTel" inputmode="numeric" placeholder="DDD + n√∫mero"></div>
      </div>
      <div class="row">
        <div class="field"><label>Chave PIX</label><input id="cPix" placeholder="CPF, e-mail, aleat√≥ria‚Ä¶"></div>
        <div class="field"><label>C√≥digo (auto: 4 √∫ltimos do tel.)</label><input id="cCodigo" placeholder="Ex.: 2603" maxlength="4"></div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn good" id="btnSalvarCourier">Salvar</button>
        <button class="btn secondary" id="btnLimparCourier">Limpar</button>
      </div>
    </div>
  </div>
</aside>

  </div>
</div>

<div class="backdrop" id="loginBackdrop" aria-hidden="true">
  <div class="modal">
    <header><b>Login</b><button class="x" id="loginClose" aria-label="Fechar">√ó</button></header>
    <div class="content">
      <div class="row">
        <div class="field"><label>E-mail</label><input id="loginEmail" type="email" placeholder="seu@email.com"></div>
        <div class="field"><label>Senha</label><input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
      </div>
      <div class="notice">Esse login √© o que libera leitura/escrita no banco.</div>
    </div>
    <div class="foot">
      <button class="btn secondary" id="loginCancel">Cancelar</button>
      <button class="btn" id="loginGo">Entrar</button>
    </div>
  </div>
</div>

<script type="module">
  const firebaseConfig = {
  apiKey: "AIzaSyBwuo9jDigmdKgfeofbc38c28v82Ia-ZJk",
  authDomain: "docce-entregas.firebaseapp.com",
  projectId: "docce-entregas",
  storageBucket: "docce-entregas.firebasestorage.app",
  messagingSenderId: "469986757222",
  appId: "1:469986757222:web:7b479ecc052830a4f53ba7",
  measurementId: "G-NXN5VD6W31"
};
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged }
    from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, getDocs, collection, addDoc,
           updateDoc, deleteDoc, query, where, orderBy }
    from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const $ = (id)=>document.getElementById(id);

  const USER_LOCALE = (navigator.language || "pt-BR");
  const brl = (n)=>Number(n||0).toLocaleString(USER_LOCALE,{style:"currency",currency:"BRL"});
  // Aceita 12,50 | 12.50 | 1.234,56 | 1,234.56
  const parseBR = (s)=>{
    let raw = String(s ?? "").trim();
    if(!raw) return 0;
    raw = raw.replace(/\s+/g,"");
    const hasComma = raw.includes(",");
    const hasDot = raw.includes(".");
    if(hasComma && hasDot){
      // decide pelo √∫ltimo separador como decimal
      const lastComma = raw.lastIndexOf(",");
      const lastDot = raw.lastIndexOf(".");
      const decSep = lastComma > lastDot ? "," : ".";
      const thouSep = decSep === "," ? "." : ",";
      raw = raw.replaceAll(thouSep, "");
      raw = decSep === "," ? raw.replace(",", ".") : raw;
    } else if(hasComma){
      raw = raw.replace(",", ".");
    } // else: s√≥ ponto ou s√≥ n√∫meros
    // remove qualquer coisa que n√£o seja n√∫mero, ponto ou sinal
    raw = raw.replace(/[^0-9.+-]/g,"");
    const v = Number(raw);
    return Number.isFinite(v) ? v : 0;
  };
  const todayISO = ()=>{const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;}
  const setMsg=(text,tone="info")=>{$("msg").textContent=text;};

  const requireAuth=()=>{ if(!auth.currentUser){ setMsg("Fa√ßa login para usar.", "warn"); throw new Error("not_authenticated"); } };

  async function salvarCourier({codigo,nome,pix,telefone}){
    requireAuth();
    await setDoc(doc(db,"couriers",String(codigo)),{nome:String(nome||"").trim(),pix:String(pix||"").trim(),telefone:String(telefone||"").trim(),active:true,updatedAt:Date.now()},{merge:true});
  }
  async function listarCouriers(){
    requireAuth();
    const snap=await getDocs(collection(db,"couriers"));
    const arr=snap.docs.map(d=>({codigo:d.id,...d.data()}));
    arr.sort((a,b)=>String(a.codigo).localeCompare(String(b.codigo)));
    return arr;
  }
  async function obterCourier(codigo){
    requireAuth();
    const snap=await getDoc(doc(db,"couriers",String(codigo)));
    return snap.exists()?{codigo:snap.id,...snap.data()}:null;
  }

  async function criarEntrega({date,courierCode,cliente,total,taxa}){
    requireAuth();
    await addDoc(collection(db,"deliveries"),{date,courierCode:courierCode?String(courierCode):"",cliente:String(cliente||"").trim(),total:Number(total||0),taxa:Number(taxa||0),status:courierCode?"assigned":"pending",createdAt:Date.now()});
  }
  async function listarEntregas(date){
    requireAuth();
    const qy=query(collection(db,"deliveries"),where("date","==",date),orderBy("createdAt","asc"));
    const snap=await getDocs(qy);
    return snap.docs.map(d=>({id:d.id,...d.data()}));
  }
  async function atribuirEntrega(id,courierCode){
    requireAuth();
    await updateDoc(doc(db,"deliveries",id),{courierCode:String(courierCode),status:"assigned"});
  }
  async function excluirEntrega(id){
    requireAuth();
    await deleteDoc(doc(db,"deliveries",id));
  }

  const state={date:todayISO(),couriers:new Map(),deliveries:[],couriersVisible:false};

    function setClosed(v){
    state.closed = !!v;
    const el = $("listResumo");
    if(!state.closed){
      $("totalTaxaDia").textContent = brl(0);
      $("totalEntregasDia").textContent = "0 entregas";
      if(el) el.innerHTML = `<div class="muted">Clique em <b>Fechar</b> para ver o resumo.</div>`;
    }
  }

function setAuthTag(isAuthed,email){
  const userBox = document.getElementById("userBox");
  const userEmail = document.getElementById("userEmail");
  const userName = document.getElementById("userName");
  const userAvatar = document.getElementById("userAvatar");

  if(isAuthed){
    const em = String(email||"").trim();
    const user = em.includes("@") ? em.split("@")[0] : em;
    userName.textContent = "Usu√°rio";
    userEmail.textContent = em || "‚Äî";
    const initial = (user && user[0]) ? user[0].toUpperCase() : (em && em[0] ? em[0].toUpperCase() : "?");
    userAvatar.textContent = initial;
    userBox.classList.remove("hidden");
  }else{
    userEmail.textContent = "‚Äî";
    userAvatar.textContent = "?";
    userBox.classList.add("hidden");
  }

  document.getElementById("btnShowCouriers").classList.toggle("hidden", !isAuthed);
  document.getElementById("btnShowCadastro").classList.toggle("hidden", !isAuthed);
  document.getElementById("btnOpenLogin").classList.toggle("hidden", isAuthed);
  document.getElementById("btnLogout").classList.toggle("hidden", !isAuthed);
}
` : "Usu√°rio: ‚Äî";
  document.getElementById("btnShowCouriers").classList.toggle("hidden", !isAuthed);
  document.getElementById("btnShowCadastro").classList.toggle("hidden", !isAuthed);
  document.getElementById("btnOpenLogin").classList.toggle("hidden", isAuthed);
  document.getElementById("btnLogout").classList.toggle("hidden", !isAuthed);
}` : "Usu√°rio: ‚Äî";
}
  function updateDayUI(){ $("day").value=state.date; $("lblDia").textContent=`Dia: ${state.date}`; }

  function escapeHtml(s){return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");}

  function renderPending(){
    const el=$("listPending"); el.innerHTML="";
    const pend=state.deliveries.filter(d=>d.status==="pending"||!d.courierCode);
    if(!pend.length){el.innerHTML=`<div class="muted">Nenhuma entrega pendente.</div>`;return;}
    for(const d of pend){
      const item=document.createElement("div"); item.className="item";
      item.innerHTML=`
        <div class="main"><b>${escapeHtml(d.cliente||"Sem nome")}</b><small>Total: ${brl(d.total)} ‚Ä¢ Taxa: ${brl(d.taxa)}</small></div>
        <div class="meta"><small class="muted">Atribuir</small><b><input data-assign="${d.id}" placeholder="0000" maxlength="4" style="width:90px;padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);color:var(--text);font:inherit;outline:none"></b></div>
        <div class="actions"><button class="btn tiny good" data-assignbtn="${d.id}">OK</button><button class="btn tiny danger" data-del="${d.id}">Excluir</button></div>`;
      el.appendChild(item);
    }
  }

  function renderAssigned(){
    const el=$("listAssigned"); el.innerHTML="";
    const assigned=state.deliveries.filter(d=>d.status==="assigned"&&d.courierCode);
    if(!assigned.length){el.innerHTML=`<div class="muted">Nenhuma entrega atribu√≠da.</div>`;return;}
    for(const d of assigned){
      const c=state.couriers.get(String(d.courierCode))||null;
      const courierName = c? (c.nome||"‚Äî") : "‚Äî";
      const item=document.createElement("div"); item.className="item";
      item.innerHTML=`
        <div class="main">
          <b>${escapeHtml(d.cliente||"Sem nome")}</b>
          <small>Entregador: ${escapeHtml(courierName)}</small>
        </div>
        <div class="meta">
          <b>${brl(d.taxa)}</b>
          <small class="muted">${brl(d.total)}</small>
        </div>
        <div class="actions">
          <button class="btn tiny secondary" data-del="${d.id}" data-action="editCourier">Editar</button>
          <button class="btn tiny danger" data-del="${d.id}" data-action="deleteDelivery">Excluir</button>
        </div>`;
      el.appendChild(item);
    }
  }


function openSide(which, title){
  hideAllSide();
  if(which) which.classList.add("active");
  sideTitle.textContent = title || "";
}

sideClose.addEventListener("click", ()=> hideAllSide());

// Menu: Fechamento / Entregadores / Cadastro
document.getElementById("btnFechamento").addEventListener("click", async ()=>{
  await closeDay(); // calcula + atualiza listResumo e totais
  openSide(sideFechamento, "Fechamento do dia");
});

document.getElementById("btnShowCouriers").addEventListener("click", async ()=>{
  await loadCouriers();
  openSide(sideCouriers, "Entregadores cadastrados");
});

document.getElementById("btnShowCadastro").addEventListener("click", ()=>{
  openSide(sideCadastro, "Cadastro");
});
  $("btnFechar").addEventListener("click", async ()=>{state.closed=true; await reloadAll(); setMsg("Fechamento atualizado.");});
  $("btnLimpar").addEventListener("click", ()=>{$("inpCliente").value="";$("inpTotal").value="";$("inpTaxa").value="";$("inpCodigoEntrega").value="";setMsg("Campos limpos.");});

  $("btnAddEntrega").addEventListener("click", async ()=>{
    try{
      requireAuth();
      const cliente=$("inpCliente").value.trim();
      const total=parseBR($("inpTotal").value);
      const taxa=parseBR($("inpTaxa").value);
      const codigo=$("inpCodigoEntrega").value.trim();
      if(!cliente) return setMsg("Informe o nome do cliente.");
      if(taxa<=0) return setMsg("Informe a taxa (R$).");
      if(codigo && !/^\d{4}$/.test(codigo)) return setMsg("C√≥digo deve ter 4 d√≠gitos.");
      if(codigo){ const c=await obterCourier(codigo); if(!c) return setMsg("Entregador n√£o encontrado. Cadastre em Entregadores."); }
      state.closed=false;
      await criarEntrega({date:state.date,courierCode:codigo||"",cliente,total,taxa});
      $("inpCliente").value="";$("inpTotal").value="";$("inpTaxa").value="";$("inpCodigoEntrega").value="";
      setMsg("Entrega adicionada.");
      await reloadAll();
    } catch(e){ if(e.message!=="not_authenticated"){console.error(e); setMsg("Erro ao adicionar.");} }
  });

  document.addEventListener("click", async (e)=>{
    const t=e.target;
    if(t?.dataset?.del){ try{requireAuth(); state.closed=false;
        await excluirEntrega(t.dataset.del); setMsg("Entrega exclu√≠da."); await reloadAll();}catch(err){console.error(err);setMsg("Erro ao excluir.");} }
    if(t?.dataset?.assignbtn){
      try{
        requireAuth();
        const id=t.dataset.assignbtn;
        const inp=document.querySelector(`input[data-assign="${id}"]`);
        const codigo=String(inp?.value||"").trim();
        if(!/^\d{4}$/.test(codigo)) return setMsg("Digite 4 d√≠gitos.");
        const c=await obterCourier(codigo); if(!c) return setMsg("Entregador n√£o encontrado. Cadastre em Entregadores.");
        state.closed=false;
        await atribuirEntrega(id,codigo); setMsg("Entregador atribu√≠do."); await reloadAll();
      }catch(err){console.error(err);setMsg("Erro ao atribuir.");}
    }
    if(t?.dataset?.edit){
      try{
        requireAuth();
        const id=t.dataset.edit;
        const novo=prompt("Novo c√≥digo (4 d√≠gitos):"); if(novo==null) return;
        const codigo=String(novo).trim(); if(!/^\d{4}$/.test(codigo)) return setMsg("C√≥digo inv√°lido.");
        const c=await obterCourier(codigo); if(!c) return setMsg("Entregador n√£o encontrado. Cadastre em Entregadores.");
        state.closed=false;
        await atribuirEntrega(id,codigo); setMsg("Entrega atualizada."); await reloadAll();
      }catch(err){console.error(err);setMsg("Erro ao editar.");}
    }
    if(t?.dataset?.deact){
      try{
        requireAuth();
        const code=String(t.dataset.deact);
        const c=state.couriers.get(code);
        const next = !(c && c.active===false);
        // next=true means currently active -> set false; if inactive -> set true
        await setDoc(doc(db,"couriers",code),{active: !next, updatedAt: Date.now()},{merge:true});
        setMsg(!next ? "Entregador ativado." : "Entregador desativado.");
        await renderCouriersList();
        await reloadAll();
      }catch(err){console.error(err); setMsg("Erro ao atualizar entregador.");}
    }
    if(t?.dataset?.fill){
      const code=String(t.dataset.fill); const c=state.couriers.get(code); if(!c) return;
      $("cCodigo").value=code; $("cNome").value=c.nome||""; $("cPix").value=c.pix||""; $("cTel").value=c.telefone||"";
      setMsg("Entregador preenchido.");
    }
  });


  $("btnSalvarCourier").addEventListener("click", async ()=>{
    try{
      requireAuth();
      // sem PIN: login j√° √© a seguran√ßa

      const nome=$("cNome").value.trim();
      const telefone=$("cTel").value.trim().replace(/\D/g,"");
      const pix=$("cPix").value.trim();
      let codigo=$("cCodigo").value.trim();
      if(!codigo && telefone.length>=4) codigo=telefone.slice(-4);
      if(!nome||!telefone||!pix) return setMsg("Preencha nome, telefone e PIX.");
      if(!/^\d{4}$/.test(codigo)) return setMsg("C√≥digo deve ter 4 d√≠gitos.");
      await salvarCourier({codigo,nome,pix,telefone});
      $("cNome").value="";$("cTel").value="";$("cPix").value="";$("cCodigo").value="";
      setMsg("Entregador salvo.");
      await reloadAll();
      await renderCouriersList();
    }catch(err){console.error(err);setMsg("Erro ao salvar entregador.");}
  });
  $("btnLimparCourier").addEventListener("click", ()=>{$("cNome").value="";$("cTel").value="";$("cPix").value="";$("cCodigo").value="";setMsg("Campos limpos.");});

  const openLogin=()=>{$("loginBackdrop").classList.add("show");};
  const closeLogin=()=>{$("loginBackdrop").classList.remove("show");};
  $("btnOpenLogin").addEventListener("click", openLogin);
  $("loginClose").addEventListener("click", closeLogin);
  $("loginCancel").addEventListener("click", closeLogin);

  $("loginGo").addEventListener("click", async ()=>{
    const email=$("loginEmail").value.trim();
    const pass=$("loginPass").value;
    if(!email||!pass) return setMsg("Informe e-mail e senha.");
    try{ await signInWithEmailAndPassword(auth,email,pass); closeLogin(); setMsg("Login efetuado."); await reloadAll(); }
    catch(e){ console.error(e); setMsg("Falha no login."); }
  });
  $("btnLogout").addEventListener("click", async ()=>{ await signOut(auth); state.couriersVisible=false; $("courierArea")?.classList.add("hidden"); $("btnOpenCouriers")?.classList.add("hidden"); setMsg("Voc√™ saiu."); });

  onAuthStateChanged(auth, async (user)=>{
    setAuthTag(!!user, (user&&user.email)||"");
    // Mostra o e-mail do usu√°rio no ‚Äútag‚Äù quando logado
    if(user){ $("authTag").textContent = `‚úÖ logado ‚Ä¢ ${user.email}`; $("btnOpenCouriers").classList.remove("hidden"); }
    else { $("authTag").textContent = "üîí sem login"; $("btnOpenCouriers").classList.add("hidden"); }
    // Se deslogou, fecha √°rea de entregadores
    if(!user){ state.couriersVisible=false; $("courierArea")?.classList.add("hidden"); }
    await reloadAll();
  });

  state.date=todayISO(); updateDayUI(); setMsg("Fa√ßa login para usar.");

function formatCPF(digits){
  const d = String(digits||"").replace(/\D/g,"");
  if(d.length!==11) return digits;
  return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9,11)}`;
}
function formatPhoneDocce(digits){
  const d = String(digits||"").replace(/\D/g,"");
  if(d.length===11){
    const dd=d.slice(0,2), part3=d.slice(2,5), part2=d.slice(5,7), part4=d.slice(7,11);
    return `${dd} ${part3} ${part2} ${part4}`;
  }
  if(d.length===10){
    const dd=d.slice(0,2), part3=d.slice(2,5), part2=d.slice(5,7), last4=d.slice(6,10);
    return `${dd} ${part3} ${part2} ${last4}`;
  }
  if(d.length>11) return formatPhoneDocce(d.slice(-11));
  return d;
}
function formatPixKey(raw){
  const s = String(raw||"").trim();
  if(!s) return "‚Äî";
  if(s.includes("@")) return s; // e-mail
  const digits = s.replace(/\D/g,"");
  // telefone com +55 (13 d√≠gitos) ou marcado por s√≠mbolos
  const looksPhone = s.includes("+") || s.includes("(") || s.includes(")") || s.includes("-") || s.includes(" ");
  if(digits.length===13 && digits.startsWith("55")) return formatPhoneDocce(digits.slice(-11));
  if((digits.length===10 || digits.length===11) && looksPhone) return formatPhoneDocce(digits);
  if(digits.length===11) return formatCPF(digits); // default: CPF
  if(digits.length===10) return formatPhoneDocce(digits);
  return s;
}
</script>
</body>
</html>