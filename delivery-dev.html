<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Docce ‚Ä¢ Entregas</title>
  <link href="https://fonts.googleapis.com/css2?family=Signika:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f0f10;--stroke:#2a2a2f;--text:#f3f3f4;--muted:#b7b7be;--good:#2ecc71;--warn:#f1c40f;--bad:#ff5c5c;--accent:#e9d7b5;--shadow:0 12px 32px rgba(0,0,0,.45);--radius:16px}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;font-family:"Signika",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:radial-gradient(1200px 800px at 20% -10%, rgba(233,215,181,.08), transparent 55%),radial-gradient(1200px 800px at 120% 20%, rgba(233,215,181,.06), transparent 55%),var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:22px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 18px;border:1px solid var(--stroke);background:rgba(23,23,25,.8);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(8px);position:sticky;top:12px;z-index:10}
    .brand{display:flex;align-items:center;gap:10px}.logo{width:36px;height:36px;border-radius:12px;border:1px solid rgba(233,215,181,.35);background:linear-gradient(145deg, rgba(233,215,181,.18), rgba(233,215,181,.04));display:grid;place-items:center;color:var(--accent);font-weight:600}
    .title{line-height:1.1}.title b{display:block;font-size:16px}.title span{display:block;font-size:12px;color:var(--muted)}
    .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{border:1px solid var(--stroke);background:rgba(29,29,32,.85);color:var(--text);padding:10px 12px;border-radius:999px;display:flex;align-items:center;gap:10px;min-height:40px}
    .pill label{font-size:12px;color:var(--muted)}.pill input{border:none;outline:none;background:transparent;color:var(--text);font:inherit;min-width:160px}.pill input[type="date"]{min-width:145px}
    .btn{border:1px solid var(--stroke);background:rgba(233,215,181,.10);color:var(--accent);padding:10px 14px;border-radius:999px;cursor:pointer;font:inherit;transition:.12s transform ease,.12s opacity ease,.12s background ease;user-select:none;white-space:nowrap}
    .btn:hover{transform:translateY(-1px);background:rgba(233,215,181,.14)}.btn:active{transform:translateY(0);opacity:.85}
    .btn.secondary{background:rgba(29,29,32,.85);color:var(--text)}.btn.danger{background:rgba(255,92,92,.10);color:var(--bad);border-color:rgba(255,92,92,.25)}.btn.good{background:rgba(46,204,113,.10);color:var(--good);border-color:rgba(46,204,113,.25)}.btn.tiny{padding:7px 10px;font-size:12px}
    .grid{margin-top:18px;display:grid;grid-template-columns:1.15fr .85fr;gap:14px}@media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{border:1px solid var(--stroke);background:rgba(23,23,25,.82);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .card header{padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px;border-bottom:1px solid var(--stroke);background:linear-gradient(180deg, rgba(233,215,181,.07), transparent)}
    .card header h2{margin:0;font-size:14px}.card header .hint{font-size:12px;color:var(--muted)}.card .body{padding:14px 16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}.row3{grid-template-columns:1fr 1fr 1fr}
    @media(max-width:700px){.row,.row3{grid-template-columns:1fr}.pill input{min-width:0}}
    .field{border:1px solid var(--stroke);background:rgba(29,29,32,.75);border-radius:14px;padding:10px 12px}
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
    .field input{width:100%;border:none;outline:none;background:transparent;color:var(--text);font:inherit;font-size:14px}
    .list{margin-top:10px;border-top:1px dashed rgba(255,255,255,.08);padding-top:10px;display:flex;flex-direction:column;gap:8px}
    .item{border:1px solid rgba(255,255,255,.08);background:rgba(29,29,32,.55);border-radius:14px;padding:10px 12px;display:grid;grid-template-columns:1.2fr .8fr auto;gap:10px;align-items:center}
    .item .main b{display:block;font-size:13px}.item .main small{display:block;color:var(--muted);font-size:12px}
    .item .meta{justify-self:end;text-align:right}.item .meta b{display:block;font-size:13px}.item .meta small{display:block;color:var(--muted);font-size:12px}
    .item .actions{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
    @media(max-width:760px){.item{grid-template-columns:1fr}.item .meta{justify-self:start;text-align:left}.item .actions{justify-content:flex-start}}
    .notice{margin-top:12px;padding:10px 12px;border-radius:14px;border:1px solid rgba(233,215,181,.18);background:rgba(233,215,181,.06);color:var(--accent);font-size:13px}
    .muted{color:var(--muted)}.sep{height:1px;background:rgba(255,255,255,.06);margin:12px 0}.hidden{display:none !important}
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.62);display:none;align-items:center;justify-content:center;padding:18px;z-index:100}
    .backdrop.show{display:flex}
    .modal{width:min(520px,100%);border:1px solid var(--stroke);background:rgba(23,23,25,.96);border-radius:18px;box-shadow:var(--shadow);overflow:hidden}
    .modal header{padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px;border-bottom:1px solid var(--stroke);background:linear-gradient(180deg, rgba(233,215,181,.08), transparent)}
    .modal header b{font-size:14px}.modal .content{padding:14px 16px}.modal .foot{padding:14px 16px;display:flex;gap:10px;justify-content:flex-end;border-top:1px solid var(--stroke)}
    .x{background:transparent;border:none;color:var(--muted);font-size:18px;cursor:pointer}.x:hover{color:var(--text)}
    .tag{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);border:1px solid rgba(255,255,255,.10);padding:6px 10px;border-radius:999px;background:rgba(29,29,32,.55)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand"><div class="logo">D</div><div class="title"><b>Docce ‚Ä¢ Entregas</b><span>Controle di√°rio com fechamento autom√°tico</span></div></div>
    <div class="right">
      <div class="pill"><label for="day">Dia</label><input id="day" type="date"></div>
      <button class="btn secondary" id="btnRefresh">Atualizar</button>
      <button class="btn" id="btnOpenLogin">Login</button>
      <button class="btn secondary hidden" id="btnLogout">Sair</button>
    </div>
  </div>

  <div class="grid">
    <section class="card">
      <header>
        <div><h2>Entregas do dia</h2><div class="hint">Cadastre o pedido (pode ficar pendente). Depois atribua o entregador.</div></div>
        <span class="tag" id="authTag">üîí sem login</span>
      </header>
      <div class="body">
        <div class="row3">
          <div class="field"><label>Cliente</label><input id="inpCliente" placeholder="Nome do cliente"></div>
          <div class="field"><label>Total (R$)</label><input id="inpTotal" inputmode="decimal" placeholder="0,00"></div>
          <div class="field"><label>Taxa (R$)</label><input id="inpTaxa" inputmode="decimal" placeholder="0,00"></div>
        </div>
        <div class="row">
          <div class="field"><label>C√≥digo do entregador (opcional)</label><input id="inpCodigoEntrega" placeholder="Ex.: 2603" maxlength="4"></div>
          <div style="display:flex;gap:10px;align-items:flex-end">
            <button class="btn good" id="btnAddEntrega">Adicionar</button>
            <button class="btn secondary" id="btnLimpar">Limpar</button>
          </div>
        </div>

        <div class="notice" id="msg"></div>

        <div class="sep"></div>
        <header style="padding:0;border:none;background:none;display:flex;align-items:center;justify-content:space-between">
          <h2 style="margin:0;font-size:14px">Aguardando entregador</h2><span class="hint">Digite o c√≥digo e atribua</span>
        </header>
        <div class="list" id="listPending"></div>

        <div class="sep"></div>
        <header style="padding:0;border:none;background:none;display:flex;align-items:center;justify-content:space-between">
          <h2 style="margin:0;font-size:14px">Entregas atribu√≠das</h2><span class="hint">Editar (trocar entregador) ou excluir</span>
        </header>
        <div class="list" id="listAssigned"></div>
      </div>
    </section>

    <aside class="card">
      <div class="body">
        <div class="item" style="grid-template-columns:1fr auto;">
          <div class="main"><b>Total de taxas do dia</b><small class="muted" id="lblDia"></small></div>
          <div class="meta"><b id="totalTaxaDia">R$ 0,00</b><small class="muted" id="totalEntregasDia">0 entregas</small></div>
        </div>

        <div class="list" id="listResumo"></div>
        <div class="sep"></div>

        <header style="padding:0;border:none;background:none;display:flex;align-items:center;justify-content:space-between">
          <h2 style="margin:0;font-size:14px">Entregadores</h2><span class="hint">√Årea protegida por PIN</span>
        </header>

        <div class="row">
          <div class="field"><label>PIN</label><input id="inpPin" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="8"></div>
          <div style="display:flex;gap:10px;align-items:flex-end">
            <button class="btn" id="btnUnlock">Entrar</button>
            <button class="btn secondary hidden" id="btnLock">Bloquear</button>
          </div>
        </div>
        <div class="hint muted">Obs.: o PIN s√≥ ‚Äúesconde‚Äù a √°rea. A seguran√ßa real √© o login do Firebase.</div>

        <div id="courierArea" class="hidden">
          <div class="sep"></div>
          <div class="row">
            <div class="field"><label>Nome</label><input id="cNome" placeholder="Nome do entregador"></div>
            <div class="field"><label>Telefone</label><input id="cTel" inputmode="numeric" placeholder="DDD + n√∫mero"></div>
          </div>
          <div class="row">
            <div class="field"><label>Chave PIX</label><input id="cPix" placeholder="CPF, e-mail, aleat√≥ria‚Ä¶"></div>
            <div class="field"><label>C√≥digo (auto: 4 √∫ltimos do telefone)</label><input id="cCodigo" placeholder="Ex.: 2603" maxlength="4"></div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn good" id="btnSalvarCourier">Salvar</button>
            <button class="btn secondary" id="btnLimparCourier">Limpar</button>
          </div>
          <div class="list" id="listCouriers"></div>
        </div>
      </div>
    </aside>
  </div>
</div>

<div class="backdrop" id="loginBackdrop" aria-hidden="true">
  <div class="modal">
    <header><b>Login</b><button class="x" id="loginClose" aria-label="Fechar">√ó</button></header>
    <div class="content">
      <div class="row">
        <div class="field"><label>E-mail</label><input id="loginEmail" type="email" placeholder="seu@email.com"></div>
        <div class="field"><label>Senha</label><input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
      </div>
      <div class="notice">Esse login √© o que libera leitura/escrita no banco.</div>
    </div>
    <div class="foot">
      <button class="btn secondary" id="loginCancel">Cancelar</button>
      <button class="btn" id="loginGo">Entrar</button>
    </div>
  </div>
</div>

<script type="module">
  const firebaseConfig = {
    apiKey: "SUA_API_KEY",
    authDomain: "SEU_AUTH_DOMAIN",
    projectId: "SEU_PROJECT_ID",
    storageBucket: "SEU_STORAGE_BUCKET",
    messagingSenderId: "SEU_MESSAGING_SENDER_ID",
    appId: "SEU_APP_ID",
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged }
    from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, getDocs, collection, addDoc,
           updateDoc, deleteDoc, query, where, orderBy }
    from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const $ = (id)=>document.getElementById(id);

  const brl = (n)=>Number(n||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
  const parseBR = (s)=>{const raw=String(s??"").trim().replace(/\./g,"").replace(",",".");const v=Number(raw);return Number.isFinite(v)?v:0;};
  const todayISO = ()=>{const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;}
  const setMsg=(text,tone="info")=>{$("msg").textContent=text;};

  const requireAuth=()=>{ if(!auth.currentUser){ setMsg("Fa√ßa login para usar.", "warn"); throw new Error("not_authenticated"); } };

  async function salvarCourier({codigo,nome,pix,telefone}){
    requireAuth();
    await setDoc(doc(db,"couriers",String(codigo)),{nome:String(nome||"").trim(),pix:String(pix||"").trim(),telefone:String(telefone||"").trim(),updatedAt:Date.now()},{merge:true});
  }
  async function listarCouriers(){
    requireAuth();
    const snap=await getDocs(collection(db,"couriers"));
    const arr=snap.docs.map(d=>({codigo:d.id,...d.data()}));
    arr.sort((a,b)=>String(a.codigo).localeCompare(String(b.codigo)));
    return arr;
  }
  async function obterCourier(codigo){
    requireAuth();
    const snap=await getDoc(doc(db,"couriers",String(codigo)));
    return snap.exists()?{codigo:snap.id,...snap.data()}:null;
  }

  async function criarEntrega({date,courierCode,cliente,total,taxa}){
    requireAuth();
    await addDoc(collection(db,"deliveries"),{date,courierCode:courierCode?String(courierCode):"",cliente:String(cliente||"").trim(),total:Number(total||0),taxa:Number(taxa||0),status:courierCode?"assigned":"pending",createdAt:Date.now()});
  }
  async function listarEntregas(date){
    requireAuth();
    const qy=query(collection(db,"deliveries"),where("date","==",date),orderBy("createdAt","asc"));
    const snap=await getDocs(qy);
    return snap.docs.map(d=>({id:d.id,...d.data()}));
  }
  async function atribuirEntrega(id,courierCode){
    requireAuth();
    await updateDoc(doc(db,"deliveries",id),{courierCode:String(courierCode),status:"assigned"});
  }
  async function excluirEntrega(id){
    requireAuth();
    await deleteDoc(doc(db,"deliveries",id));
  }

  const state={date:todayISO(),couriers:new Map(),deliveries:[],courierPinUnlocked:false,PIN:"2603"};

  function setAuthTag(on){
    $("authTag").textContent = on ? "‚úÖ logado" : "üîí sem login";
    $("btnLogout").classList.toggle("hidden", !on);
    $("btnOpenLogin").classList.toggle("hidden", on);
  }
  function updateDayUI(){ $("day").value=state.date; $("lblDia").textContent=`Dia: ${state.date}`; }

  function escapeHtml(s){return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");}

  function renderPending(){
    const el=$("listPending"); el.innerHTML="";
    const pend=state.deliveries.filter(d=>d.status==="pending"||!d.courierCode);
    if(!pend.length){el.innerHTML=`<div class="muted">Nenhuma entrega pendente.</div>`;return;}
    for(const d of pend){
      const item=document.createElement("div"); item.className="item";
      item.innerHTML=`
        <div class="main"><b>${escapeHtml(d.cliente||"Sem nome")}</b><small>Total: ${brl(d.total)} ‚Ä¢ Taxa: ${brl(d.taxa)}</small></div>
        <div class="meta"><small class="muted">Atribuir</small><b><input data-assign="${d.id}" placeholder="0000" maxlength="4" style="width:90px;padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);color:var(--text);font:inherit;outline:none"></b></div>
        <div class="actions"><button class="btn tiny good" data-assignbtn="${d.id}">OK</button><button class="btn tiny danger" data-del="${d.id}">Excluir</button></div>`;
      el.appendChild(item);
    }
  }

  function renderAssigned(){
    const el=$("listAssigned"); el.innerHTML="";
    const assigned=state.deliveries.filter(d=>d.status==="assigned"&&d.courierCode);
    if(!assigned.length){el.innerHTML=`<div class="muted">Nenhuma entrega atribu√≠da.</div>`;return;}
    for(const d of assigned){
      const c=state.couriers.get(String(d.courierCode))||null;
      const title=c?`${c.nome} (${d.courierCode})`:`C√≥digo ${d.courierCode}`;
      const pix=c?.pix?`PIX: ${c.pix}`:"PIX: ‚Äî";
      const item=document.createElement("div"); item.className="item";
      item.innerHTML=`
        <div class="main"><b>${escapeHtml(d.cliente||"Sem nome")} ‚Ä¢ <span style="color:var(--accent)">${escapeHtml(title)}</span></b><small>${escapeHtml(pix)} ‚Ä¢ Taxa: ${brl(d.taxa)}</small></div>
        <div class="meta"><b>${brl(d.taxa)}</b><small class="muted">${brl(d.total)}</small></div>
        <div class="actions"><button class="btn tiny secondary" data-edit="${d.id}">Editar</button><button class="btn tiny danger" data-del="${d.id}">Excluir</button></div>`;
      el.appendChild(item);
    }
  }

  function renderResumo(){
    const assigned=state.deliveries.filter(d=>d.status==="assigned"&&d.courierCode);
    const totalTaxas=assigned.reduce((a,d)=>a+Number(d.taxa||0),0);
    $("totalTaxaDia").textContent=brl(totalTaxas);
    $("totalEntregasDia").textContent=`${assigned.length} entregas`;
    const by=new Map();
    for(const d of assigned){const code=String(d.courierCode);by.set(code,(by.get(code)||0)+Number(d.taxa||0));}
    const el=$("listResumo"); el.innerHTML="";
    const entries=Array.from(by.entries()).sort((a,b)=>b[1]-a[1]);
    if(!entries.length){el.innerHTML=`<div class="muted">Sem fechamento ainda.</div>`;return;}
    for(const [code,sum] of entries){
      const c=state.couriers.get(code); const name=c?.nome||"Entregador"; const pix=c?.pix||"‚Äî";
      const row=document.createElement("div"); row.className="item"; row.style.gridTemplateColumns="1fr auto";
      row.innerHTML=`<div class="main"><b>${escapeHtml(name)} <span class="muted">(${escapeHtml(code)})</span></b><small class="muted">PIX: ${escapeHtml(pix)}</small></div><div class="meta"><b>${brl(sum)}</b><small class="muted">taxas</small></div>`;
      el.appendChild(row);
    }
  }

  async function renderCouriersList(){
    const el=$("listCouriers"); el.innerHTML="";
    if(!state.courierPinUnlocked){el.innerHTML=`<div class="muted">√Årea bloqueada.</div>`;return;}
    try{
      const arr=await listarCouriers();
      state.couriers.clear(); for(const c of arr) state.couriers.set(String(c.codigo), c);
      if(!arr.length){el.innerHTML=`<div class="muted">Nenhum entregador cadastrado.</div>`;return;}
      for(const c of arr){
        const item=document.createElement("div"); item.className="item"; item.style.gridTemplateColumns="1fr auto";
        item.innerHTML=`<div class="main"><b>${escapeHtml(c.nome||"‚Äî")} <span class="muted">(${escapeHtml(String(c.codigo))})</span></b><small class="muted">PIX: ${escapeHtml(c.pix||"‚Äî")} ‚Ä¢ Tel: ${escapeHtml(c.telefone||"‚Äî")}</small></div><div class="actions"><button class="btn tiny secondary" data-fill="${escapeHtml(String(c.codigo))}">Preencher</button></div>`;
        el.appendChild(item);
      }
    } catch { el.innerHTML=`<div class="muted">Fa√ßa login para listar entregadores.</div>`; }
  }

  async function reloadAll(){
    updateDayUI();
    if(!auth.currentUser){
      state.deliveries=[];
      $("listPending").innerHTML=`<div class="muted">Fa√ßa login para visualizar entregas.</div>`;
      $("listAssigned").innerHTML=`<div class="muted">Fa√ßa login para visualizar entregas.</div>`;
      $("listResumo").innerHTML=`<div class="muted">Fa√ßa login para visualizar fechamento.</div>`;
      $("totalTaxaDia").textContent=brl(0); $("totalEntregasDia").textContent="0 entregas";
      return;
    }
    const cour=await listarCouriers();
    state.couriers.clear(); for(const c of cour) state.couriers.set(String(c.codigo), c);
    state.deliveries=await listarEntregas(state.date);
    renderPending(); renderAssigned(); renderResumo();
    if(state.courierPinUnlocked) await renderCouriersList();
  }

  $("day").addEventListener("change", async (e)=>{state.date=e.target.value||todayISO();await reloadAll();});
  $("btnRefresh").addEventListener("click", reloadAll);
  // (Visual) Removido o cabe√ßalho do Fechamento, ent√£o o bot√£o pode n√£o existir.
  const _btnFechar = $("btnFechar");
  if(_btnFechar) _btnFechar.addEventListener("click", async ()=>{await reloadAll(); setMsg("Fechamento atualizado.");});
  $("btnLimpar").addEventListener("click", ()=>{$("inpCliente").value="";$("inpTotal").value="";$("inpTaxa").value="";$("inpCodigoEntrega").value="";setMsg("Campos limpos.");});

  $("btnAddEntrega").addEventListener("click", async ()=>{
    try{
      requireAuth();
      const cliente=$("inpCliente").value.trim();
      const total=parseBR($("inpTotal").value);
      const taxa=parseBR($("inpTaxa").value);
      const codigo=$("inpCodigoEntrega").value.trim();
      if(!cliente) return setMsg("Informe o nome do cliente.");
      if(taxa<=0) return setMsg("Informe a taxa (R$).");
      if(codigo && !/^\d{4}$/.test(codigo)) return setMsg("C√≥digo deve ter 4 d√≠gitos.");
      if(codigo){ const c=await obterCourier(codigo); if(!c) return setMsg("Entregador n√£o encontrado. Cadastre em Entregadores."); }
      await criarEntrega({date:state.date,courierCode:codigo||"",cliente,total,taxa});
      $("inpCliente").value="";$("inpTotal").value="";$("inpTaxa").value="";$("inpCodigoEntrega").value="";
      setMsg("Entrega adicionada.");
      await reloadAll();
    } catch(e){ if(e.message!=="not_authenticated"){console.error(e); setMsg("Erro ao adicionar.");} }
  });

  document.addEventListener("click", async (e)=>{
    const t=e.target;
    if(t?.dataset?.del){ try{requireAuth(); await excluirEntrega(t.dataset.del); setMsg("Entrega exclu√≠da."); await reloadAll();}catch(err){console.error(err);setMsg("Erro ao excluir.");} }
    if(t?.dataset?.assignbtn){
      try{
        requireAuth();
        const id=t.dataset.assignbtn;
        const inp=document.querySelector(`input[data-assign="${id}"]`);
        const codigo=String(inp?.value||"").trim();
        if(!/^\d{4}$/.test(codigo)) return setMsg("Digite 4 d√≠gitos.");
        const c=await obterCourier(codigo); if(!c) return setMsg("Entregador n√£o encontrado. Cadastre em Entregadores.");
        await atribuirEntrega(id,codigo); setMsg("Entregador atribu√≠do."); await reloadAll();
      }catch(err){console.error(err);setMsg("Erro ao atribuir.");}
    }
    if(t?.dataset?.edit){
      try{
        requireAuth();
        const id=t.dataset.edit;
        const novo=prompt("Novo c√≥digo (4 d√≠gitos):"); if(novo==null) return;
        const codigo=String(novo).trim(); if(!/^\d{4}$/.test(codigo)) return setMsg("C√≥digo inv√°lido.");
        const c=await obterCourier(codigo); if(!c) return setMsg("Entregador n√£o encontrado. Cadastre em Entregadores.");
        await atribuirEntrega(id,codigo); setMsg("Entrega atualizada."); await reloadAll();
      }catch(err){console.error(err);setMsg("Erro ao editar.");}
    }
    if(t?.dataset?.fill){
      const code=String(t.dataset.fill); const c=state.couriers.get(code); if(!c) return;
      $("cCodigo").value=code; $("cNome").value=c.nome||""; $("cPix").value=c.pix||""; $("cTel").value=c.telefone||"";
      setMsg("Entregador preenchido.");
    }
  });

  function lockCourierArea(){state.courierPinUnlocked=false;$("courierArea").classList.add("hidden");$("btnLock").classList.add("hidden");$("btnUnlock").classList.remove("hidden");$("inpPin").value="";}
  $("btnUnlock").addEventListener("click", async ()=>{ if($("inpPin").value.trim()!==state.PIN) return setMsg("PIN incorreto."); state.courierPinUnlocked=true;$("courierArea").classList.remove("hidden");$("btnLock").classList.remove("hidden");$("btnUnlock").classList.add("hidden");setMsg("√Årea liberada."); await renderCouriersList(); });
  $("btnLock").addEventListener("click", ()=>{lockCourierArea();setMsg("√Årea bloqueada.");});

  $("btnSalvarCourier").addEventListener("click", async ()=>{
    try{
      requireAuth();
      if(!state.courierPinUnlocked) return setMsg("Desbloqueie com PIN.");
      const nome=$("cNome").value.trim();
      const telefone=$("cTel").value.trim().replace(/\D/g,"");
      const pix=$("cPix").value.trim();
      let codigo=$("cCodigo").value.trim();
      if(!codigo && telefone.length>=4) codigo=telefone.slice(-4);
      if(!nome||!telefone||!pix) return setMsg("Preencha nome, telefone e PIX.");
      if(!/^\d{4}$/.test(codigo)) return setMsg("C√≥digo deve ter 4 d√≠gitos.");
      await salvarCourier({codigo,nome,pix,telefone});
      $("cNome").value="";$("cTel").value="";$("cPix").value="";$("cCodigo").value="";
      setMsg("Entregador salvo.");
      await reloadAll();
      await renderCouriersList();
    }catch(err){console.error(err);setMsg("Erro ao salvar entregador.");}
  });
  $("btnLimparCourier").addEventListener("click", ()=>{$("cNome").value="";$("cTel").value="";$("cPix").value="";$("cCodigo").value="";setMsg("Campos limpos.");});

  const openLogin=()=>{$("loginBackdrop").classList.add("show");};
  const closeLogin=()=>{$("loginBackdrop").classList.remove("show");};
  $("btnOpenLogin").addEventListener("click", openLogin);
  $("loginClose").addEventListener("click", closeLogin);
  $("loginCancel").addEventListener("click", closeLogin);

  $("loginGo").addEventListener("click", async ()=>{
    const email=$("loginEmail").value.trim();
    const pass=$("loginPass").value;
    if(!email||!pass) return setMsg("Informe e-mail e senha.");
    try{ await signInWithEmailAndPassword(auth,email,pass); closeLogin(); setMsg("Login efetuado."); await reloadAll(); }
    catch(e){ console.error(e); setMsg("Falha no login."); }
  });
  $("btnLogout").addEventListener("click", async ()=>{ await signOut(auth); lockCourierArea(); setMsg("Voc√™ saiu."); });

  onAuthStateChanged(auth, async (user)=>{ setAuthTag(!!user); await reloadAll(); });

  state.date=todayISO(); updateDayUI(); setMsg("Fa√ßa login para usar.");
</script>
</body>
</html>
